/**
 * Regex-based security vulnerability detector.
 * Runs on already-fetched file content during scans — no external dependencies.
 */

export type VulnerabilitySeverity = 'critical' | 'high' | 'medium' | 'low';

export interface VulnerabilityFinding {
  id: string;
  severity: VulnerabilitySeverity;
  category: string;
  title: string;
  description: string;
  line: number;
  matchedText: string;
  cwe?: string;
}

export interface VulnerabilityResult {
  total_findings: number;
  critical_count: number;
  high_count: number;
  medium_count: number;
  low_count: number;
  findings: VulnerabilityFinding[];
  scanned: boolean;
}

interface VulnerabilityRule {
  id: string;
  severity: VulnerabilitySeverity;
  category: string;
  title: string;
  description: string;
  pattern: RegExp;
  languages: string[] | '*';
  cwe?: string;
  truncateMatch?: boolean;
}

// ---------------------------------------------------------------------------
// Rule registry
// ---------------------------------------------------------------------------

const RULES: VulnerabilityRule[] = [
  // ── Critical ────────────────────────────────────────────────────────────
  {
    id: 'VULN-001',
    severity: 'critical',
    category: 'hardcoded-secret',
    title: 'Hardcoded AWS Access Key',
    description: 'AWS access key IDs should never be committed to source code. Use environment variables or a secrets manager.',
    pattern: /AKIA[0-9A-Z]{16}/,
    languages: '*',
    cwe: 'CWE-798',
    truncateMatch: true,
  },
  {
    id: 'VULN-002',
    severity: 'critical',
    category: 'hardcoded-secret',
    title: 'Hardcoded Password',
    description: 'Passwords in source code can be extracted by anyone with repo access. Use environment variables or a vault.',
    pattern: /(?:password|passwd|pwd)\s*[:=]\s*['"][^'"]{8,}['"]/i,
    languages: '*',
    cwe: 'CWE-798',
    truncateMatch: true,
  },
  {
    id: 'VULN-003',
    severity: 'critical',
    category: 'hardcoded-secret',
    title: 'Hardcoded API Key or Token',
    description: 'API keys and tokens should be stored in environment variables, not in code.',
    pattern: /(?:api[_-]?key|apikey|secret[_-]?key|auth[_-]?token|access[_-]?token)\s*[:=]\s*['"][^'"]{8,}['"]/i,
    languages: '*',
    cwe: 'CWE-798',
    truncateMatch: true,
  },
  {
    id: 'VULN-004',
    severity: 'critical',
    category: 'hardcoded-secret',
    title: 'Hardcoded GitHub Token',
    description: 'GitHub personal access tokens or app tokens should never be committed. Rotate this token immediately.',
    pattern: /(?:ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9_]{36,}/,
    languages: '*',
    cwe: 'CWE-798',
    truncateMatch: true,
  },
  {
    id: 'VULN-005',
    severity: 'critical',
    category: 'code-injection',
    title: 'Dynamic eval() Usage',
    description: 'eval() with dynamic input allows arbitrary code execution. Use safer alternatives like JSON.parse() or AST-based evaluation.',
    pattern: /\beval\s*\(\s*(?!['"`])[^)]+\)/,
    languages: ['JavaScript', 'TypeScript', 'Python'],
    cwe: 'CWE-95',
  },
  {
    id: 'VULN-006',
    severity: 'critical',
    category: 'sql-injection',
    title: 'Potential SQL Injection',
    description: 'String interpolation in SQL queries allows injection attacks. Use parameterized queries or an ORM.',
    pattern: /(?:query|execute|raw)\s*\(\s*[`'"](?:SELECT|INSERT|UPDATE|DELETE|DROP|ALTER)\b.*\$\{/i,
    languages: ['JavaScript', 'TypeScript', 'Python'],
    cwe: 'CWE-89',
  },
  {
    id: 'VULN-007',
    severity: 'critical',
    category: 'hardcoded-secret',
    title: 'Private Key in Source Code',
    description: 'Private keys must never be stored in source code. Move to a secrets manager and rotate immediately.',
    pattern: /-----BEGIN (?:RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----/,
    languages: '*',
    cwe: 'CWE-798',
    truncateMatch: true,
  },

  // ── High ────────────────────────────────────────────────────────────────
  {
    id: 'VULN-010',
    severity: 'high',
    category: 'xss',
    title: 'innerHTML Assignment',
    description: 'Setting innerHTML with untrusted data enables XSS attacks. Use textContent or a sanitization library.',
    pattern: /\.innerHTML\s*=/,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-79',
  },
  {
    id: 'VULN-011',
    severity: 'high',
    category: 'xss',
    title: 'dangerously' + 'SetInnerHTML Usage',
    description: 'dangerously' + 'SetInnerHTML bypasses React XSS protections. Sanitize input with DOMPurify or similar.',
    pattern: /dangerouslySetInnerHTML/,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-79',
  },
  {
    id: 'VULN-012',
    severity: 'high',
    category: 'xss',
    title: 'document' + '.write() Usage',
    description: 'document' + '.write() with dynamic content enables XSS. Use DOM manipulation APIs instead.',
    pattern: /document\.write\s*\(/,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-79',
  },
  {
    id: 'VULN-013',
    severity: 'high',
    category: 'command-injection',
    title: 'Command Injection Risk',
    description: 'Passing dynamic strings to exec/spawn can lead to command injection. Use execFile with argument arrays.',
    pattern: /(?:exec|execSync|spawnSync)\s*\(\s*(?!['"`])/,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-78',
  },
  {
    id: 'VULN-014',
    severity: 'high',
    category: 'command-injection',
    title: 'Python Command Injection Risk',
    description: 'os.system() and subprocess with shell=True and dynamic strings allow command injection. Use subprocess with a list of arguments.',
    pattern: /(?:os\.system|subprocess\.(?:call|run|Popen))\s*\(\s*f['"`]/,
    languages: ['Python'],
    cwe: 'CWE-78',
  },

  // ── Medium ──────────────────────────────────────────────────────────────
  {
    id: 'VULN-020',
    severity: 'medium',
    category: 'weak-crypto',
    title: 'Math' + '.random() for Security',
    description: 'Math' + '.random() is not cryptographically secure. Use crypto.getRandomValues() or crypto.randomBytes() for tokens/keys.',
    pattern: /Math\.random\s*\(\s*\).*(?:token|key|secret|password|hash|salt|nonce|session)/i,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-330',
  },
  {
    id: 'VULN-021',
    severity: 'medium',
    category: 'weak-crypto',
    title: 'Weak Hash Algorithm (MD5/SHA1)',
    description: 'MD5 and SHA1 are cryptographically broken. Use SHA-256 or stronger for hashing.',
    pattern: /createHash\s*\(\s*['"](?:md5|sha1)['"]\s*\)/i,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-328',
  },
  {
    id: 'VULN-022',
    severity: 'medium',
    category: 'weak-crypto',
    title: 'Weak Hash Algorithm (Python)',
    description: 'MD5 and SHA1 are cryptographically broken. Use hashlib.sha256() or stronger.',
    pattern: /hashlib\.(?:md5|sha1)\s*\(/,
    languages: ['Python'],
    cwe: 'CWE-328',
  },
  {
    id: 'VULN-023',
    severity: 'medium',
    category: 'insecure-config',
    title: 'Insecure Cookie Configuration',
    description: 'Cookies without httpOnly or secure flags are vulnerable to XSS and MITM attacks.',
    pattern: /(?:httpOnly|HttpOnly|httponly)\s*:\s*false/,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-614',
  },
  {
    id: 'VULN-024',
    severity: 'medium',
    category: 'info-exposure',
    title: 'Sensitive Data in Logs',
    description: 'Logging passwords, tokens, or secrets exposes them in log files and monitoring systems.',
    pattern: /console\.log\s*\(.*(?:password|secret|token|apiKey|api_key|credential)/i,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-532',
  },

  // ── Low ─────────────────────────────────────────────────────────────────
  {
    id: 'VULN-030',
    severity: 'low',
    category: 'todo-security',
    title: 'Security TODO/FIXME Comment',
    description: 'A security-related task has been deferred. Ensure it is tracked and addressed.',
    pattern: /(?:TODO|FIXME|HACK|XXX).*(?:security|auth|vuln|exploit|injection|xss|csrf)/i,
    languages: '*',
  },
  {
    id: 'VULN-031',
    severity: 'low',
    category: 'deprecated-api',
    title: 'Deprecated Buffer' + '() Constructor',
    description: 'new ' + 'Buffer() is deprecated and can cause security issues. Use Buffer.from(), Buffer.alloc(), or Buffer.allocUnsafe().',
    pattern: /new\s+Buffer\s*\(/,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-676',
  },
  {
    id: 'VULN-032',
    severity: 'low',
    category: 'deprecated-api',
    title: 'Deprecated ' + 'escape()/unescape()',
    description: 'Global ' + 'escape() and unescape() are deprecated. Use encodeURIComponent()/decodeURIComponent().',
    pattern: /(?<![.\w])(?:escape|unescape)\s*\(/,
    languages: ['JavaScript', 'TypeScript'],
    cwe: 'CWE-676',
  },
];

// ---------------------------------------------------------------------------
// Helpers
// ---------------------------------------------------------------------------

const COMMENT_PREFIXES: Record<string, RegExp[]> = {
  JavaScript: [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  TypeScript: [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  Python: [/^\s*#/],
  Ruby: [/^\s*#/],
  Shell: [/^\s*#/],
  Go: [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  Rust: [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  Java: [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  'C#': [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  'C++': [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  C: [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  PHP: [/^\s*\/\//, /^\s*#/, /^\s*\/\*/, /^\s*\*/],
  Swift: [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  Kotlin: [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
  Scala: [/^\s*\/\//, /^\s*\/\*/, /^\s*\*/],
};

function isCommentLine(line: string, language: string): boolean {
  const prefixes = COMMENT_PREFIXES[language];
  if (!prefixes) return false;
  return prefixes.some((p) => p.test(line));
}

function truncateSecret(text: string): string {
  if (text.length <= 8) return '***';
  const show = Math.min(4, Math.floor(text.length / 4));
  return text.slice(0, show) + '***' + text.slice(-show);
}

// ---------------------------------------------------------------------------
// Main detector
// ---------------------------------------------------------------------------

export function detectVulnerabilities(
  code: string,
  language: string,
): VulnerabilityResult {
  const findings: VulnerabilityFinding[] = [];
  const lines = code.split('\n');
  const seen = new Set<string>(); // dedup key: ruleId:line

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // Skip empty lines
    if (line.trim().length === 0) continue;

    // Skip comment-only lines (except for VULN-030 which specifically targets comments)
    const isComment = isCommentLine(line, language);

    for (const rule of RULES) {
      // Language filter
      if (rule.languages !== '*' && !rule.languages.includes(language)) continue;

      // Only scan comments for the deferred-task rule
      if (isComment && rule.id !== 'VULN-030') continue;
      // The deferred-task rule only applies to comments
      if (!isComment && rule.id === 'VULN-030') continue;

      const match = line.match(rule.pattern);
      if (match) {
        const dedupKey = `${rule.id}:${i + 1}`;
        if (seen.has(dedupKey)) continue;
        seen.add(dedupKey);

        findings.push({
          id: rule.id,
          severity: rule.severity,
          category: rule.category,
          title: rule.title,
          description: rule.description,
          line: i + 1,
          matchedText: rule.truncateMatch
            ? truncateSecret(match[0])
            : match[0].substring(0, 100),
          cwe: rule.cwe,
        });
      }
    }
  }

  return {
    total_findings: findings.length,
    critical_count: findings.filter((f) => f.severity === 'critical').length,
    high_count: findings.filter((f) => f.severity === 'high').length,
    medium_count: findings.filter((f) => f.severity === 'medium').length,
    low_count: findings.filter((f) => f.severity === 'low').length,
    findings,
    scanned: true,
  };
}
